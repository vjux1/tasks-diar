<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú–æ–∏ –∑–∞–¥–∞—á–∏</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root {
      --bg: #0f0f1b;
      --card-bg: rgba(20, 20, 35, 0.7);
      --text-color: #e0e0ff;
      --accent: #6a5acd;
      --input-bg: rgba(30, 30, 50, 0.6);
      --border-radius: 16px;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      --completed: #4ade80;
      --pending: #f87171;
      --profit: #fbbf24;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--bg), #1a1a2e);
      background-image: url('bg.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      color: var(--text-color);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(106, 90, 205, 0.3);
    }

    h1 {
      font-size: 28px;
      font-weight: 600;
      background: linear-gradient(to right, #a78bfa, #c4b5fd);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .tab {
      background: var(--card-bg);
      border: none;
      color: var(--text-color);
      padding: 8px 16px;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .tab.active, .tab:hover {
      background: var(--accent);
      color: white;
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .section-title {
      font-size: 18px;
      margin-bottom: 16px;
      color: #c4b5fd;
      font-weight: 600;
    }

    .task-input,
    .note-input,
    .profit-input {
      width: 100%;
      padding: 12px;
      background: var(--input-bg);
      border: 1px solid rgba(106, 90, 205, 0.4);
      border-radius: 12px;
      color: var(--text-color);
      margin-bottom: 12px;
      font-size: 16px;
    }

    .task-input:focus,
    .note-input:focus,
    .profit-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .add-btn {
      background: var(--accent);
      color: white;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .input-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .filter-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: var(--input-bg);
      border: 1px solid rgba(106, 90, 205, 0.4);
      color: var(--text-color);
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }

    .filter-btn.active {
      background: var(--accent);
      border-color: var(--accent);
    }

    .task-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: rgba(30, 30, 50, 0.5);
      border-radius: 10px;
      margin-bottom: 12px;
      position: relative;
    }

    .task-checkbox {
      margin-right: 12px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .task-text {
      flex: 1;
      word-break: break-word;
      font-size: 16px;
    }

    .task-text.completed {
      text-decoration: line-through;
      color: #888;
    }

    .task-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 10px;
    }

    .delete-btn {
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 18px;
      cursor: pointer;
      margin-left: 10px;
    }

    .stats {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      font-size: 14px;
      color: #aaa;
    }

    .xp-bar {
      height: 8px;
      background: rgba(100, 100, 120, 0.3);
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
    }

    .xp-fill {
      height: 100%;
      background: linear-gradient(to right, #8b5cf6, #c084fc);
      width: 0%;
      transition: width 0.4s ease;
    }

    .empty-state {
      color: #666;
      font-style: italic;
      text-align: center;
      padding: 16px;
    }

    .hidden {
      display: none;
    }

    .progress-circle {
      width: 120px;
      height: 120px;
      position: relative;
      margin: 0 auto 16px;
    }

    .progress-bg, .progress-fill {
      fill: none;
      stroke-width: 10;
      r: 50;
      cx: 60;
      cy: 60;
    }

    .progress-bg {
      stroke: rgba(106, 90, 205, 0.2);
    }

    .progress-fill {
      stroke: var(--profit);
      stroke-linecap: round;
      transform: rotate(-90deg);
      transform-origin: 60px 60px;
      transition: stroke-dashoffset 0.5s ease;
    }

    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      font-weight: bold;
      color: var(--text-color);
    }

    .snowflake {
      position: absolute;
      color: white;
      font-size: 1em;
      opacity: 0.8;
      user-select: none;
      z-index: -1;
    }

    .logo {
      position: fixed;
      bottom: 20px;
      right: 20px;
      font-size: 24px;
      color: var(--accent);
      opacity: 0.7;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      .input-row, .filter-buttons {
        flex-direction: column;
        gap: 8px;
      }
      .add-btn {
        align-self: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>–ú–æ–∏ –∑–∞–¥–∞—á–∏</h1>
      <div id="xpDisplay">–£—Ä–æ–≤–µ–Ω—å: <span id="level">1</span> | XP: <span id="xp">0</span>/<span id="nextLevelXp">100</span></div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="tasks">–ó–∞–¥–∞—á–∏</button>
      <button class="tab" data-tab="notes">–ó–∞–º–µ—Ç–∫–∏</button>
      <button class="tab" data-tab="profit">–ü—Ä–∏–±—ã–ª—å</button>
    </div>

    <!-- –ó–∞–¥–∞—á–∏ -->
    <div id="tasks-tab" class="card">
      <div class="section-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</div>
      <div class="input-row">
        <input type="text" id="taskInput" class="task-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É..." />
        <select id="taskColor" class="task-input" style="width: auto; padding: 12px;">
          <option value="#8b5cf6">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
          <option value="#ef4444">–ö—Ä–∞—Å–Ω—ã–π</option>
          <option value="#10b981">–ó–µ–ª—ë–Ω—ã–π</option>
          <option value="#f59e0b">–û—Ä–∞–Ω–∂–µ–≤—ã–π</option>
          <option value="#3b82f6">–°–∏–Ω–∏–π</option>
        </select>
        <button id="addTaskBtn" class="add-btn">+</button>
      </div>

      <div class="filter-buttons">
        <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
        <button class="filter-btn" data-filter="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
        <button class="filter-btn" data-filter="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</button>
      </div>

      <div id="tasksList">
        <div class="empty-state">–ù–µ—Ç –∑–∞–¥–∞—á</div>
      </div>

      <div class="stats">
        <span>–í—Å–µ–≥–æ: <span id="totalTasks">0</span></span>
        <span>–ê–∫—Ç–∏–≤–Ω—ã—Ö: <span id="activeTasks">0</span></span>
        <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ: <span id="completedTasks">0</span></span>
      </div>
    </div>

    <!-- –ó–∞–º–µ—Ç–∫–∏ -->
    <div id="notes-tab" class="card hidden">
      <div class="section-title">–ó–∞–º–µ—Ç–∫–∏</div>
      <textarea id="noteInput" class="note-input" rows="5" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É..."></textarea>
      <div style="text-align: right; color: #aaa; font-size: 14px;">
        <span id="charCount">0</span>/1000
      </div>
      <button id="saveNoteBtn" class="add-btn" style="align-self: flex-start; margin-top: 8px;">üíæ</button>
    </div>

    <!-- –ü—Ä–∏–±—ã–ª—å -->
    <div id="profit-tab" class="card hidden">
      <div class="section-title">–¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–±—ã–ª–∏</div>
      <div class="input-row">
        <input type="number" id="targetInput" class="profit-input" placeholder="–¶–µ–ª—å (CHF)" />
        <input type="number" id="currentInput" class="profit-input" placeholder="–¢–µ–∫—É—â–∞—è –ø—Ä–∏–±—ã–ª—å (CHF)" />
      </div>
      <button id="updateProfitBtn" class="add-btn" style="align-self: flex-start;">üìä</button>

      <div class="progress-circle">
        <svg width="120" height="120">
          <circle class="progress-bg" />
          <circle class="progress-fill" id="profitCircle" stroke-dasharray="314" stroke-dashoffset="314" />
        </svg>
        <div class="progress-text" id="profitPercent">0%</div>
      </div>

      <div id="profitDisplay" style="text-align: center; margin-top: 10px;"></div>
    </div>
  </div>

  <div class="logo">‚ú®</div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // ========== –£—Ç–∏–ª–∏—Ç—ã ==========
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getToday() {
      const now = new Date();
      return now.toISOString().split('T')[0];
    }

    // ========== –í–∫–ª–∞–¥–∫–∏ ==========
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));

        tab.classList.add('active');
        const targetId = tab.dataset.tab + '-tab';
        document.getElementById(targetId).classList.remove('hidden');
      });
    });

    // ========== –ó–∞–¥–∞—á–∏ ==========
    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    let currentFilter = 'all';

    const taskInput = document.getElementById('taskInput');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const tasksList = document.getElementById('tasksList');
    const filterButtons = document.querySelectorAll('.filter-btn');

    function renderTasks() {
      const filteredTasks = tasks.filter(task => {
        if (currentFilter === 'active') return !task.completed;
        if (currentFilter === 'completed') return task.completed;
        return true;
      });

      if (filteredTasks.length === 0) {
        tasksList.innerHTML = '<div class="empty-state">–ù–µ—Ç –∑–∞–¥–∞—á</div>';
        return;
      }

      tasksList.innerHTML = '';
      filteredTasks.forEach(task => {
        const taskDiv = document.createElement('div');
        taskDiv.className = 'task-item';
        taskDiv.innerHTML = `
          <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} data-id="${task.id}">
          <span class="task-text ${task.completed ? 'completed' : ''}">${escapeHtml(task.text)}</span>
          <div class="task-color" style="background:${task.color}"></div>
          <button class="delete-btn" data-id="${task.id}">üóëÔ∏è</button>
        `;
        tasksList.appendChild(taskDiv);
      });
    }

    function updateStats() {
      const total = tasks.length;
      const completed = tasks.filter(t => t.completed).length;
      const active = total - completed;

      document.getElementById('totalTasks').textContent = total;
      document.getElementById('activeTasks').textContent = active;
      document.getElementById('completedTasks').textContent = completed;
    }

    function updateDailyProgressAndStreak() {
      const today = getToday();
      const completedToday = tasks.filter(t => t.completed && t.createdAt === today).length;
      const streak = calculateStreak();

      // –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–Ω—è
    }

    function calculateStreak() {
      const dates = [...new Set(tasks.filter(t => t.completed).map(t => t.createdAt))].sort();
      let streak = 0;
      const today = new Date();
      let currentDate = new Date(today);

      while (dates.includes(currentDate.toISOString().split('T')[0])) {
        streak++;
        currentDate.setDate(currentDate.getDate() - 1);
      }
      return streak;
    }

    // üî• –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: unshift –≤–º–µ—Å—Ç–æ push
    function addTask() {
      const input = document.getElementById('taskInput');
      const colorSelect = document.getElementById('taskColor');
      const text = input.value.trim();
      const color = colorSelect.value;
      if (text) {
        tasks.unshift({ // ‚Üê –ù–û–í–ê–Ø –ó–ê–î–ê–ß–ê –î–û–ë–ê–í–õ–Ø–ï–¢–°–Ø –í –ù–ê–ß–ê–õ–û –ú–ê–°–°–ò–í–ê
          id: Date.now(),
          text: text,
          completed: false,
          color: color,
          createdAt: getToday()
        });
        input.value = '';
        saveData();
        updateStats();
        updateDailyProgressAndStreak();
        renderTasks();
        addXP(10);
      }
    }

    addTaskBtn.addEventListener('click', addTask);
    taskInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addTask();
    });

    tasksList.addEventListener('click', (e) => {
      if (e.target.classList.contains('task-checkbox')) {
        const id = parseInt(e.target.dataset.id);
        const task = tasks.find(t => t.id === id);
        if (task) {
          task.completed = e.target.checked;
          saveData();
          updateStats();
          updateDailyProgressAndStreak();
          renderTasks();
          if (task.completed) addXP(20);
        }
      } else if (e.target.classList.contains('delete-btn')) {
        const id = parseInt(e.target.dataset.id);
        tasks = tasks.filter(t => t.id !== id);
        saveData();
        updateStats();
        updateDailyProgressAndStreak();
        renderTasks();
      }
    });

    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        filterButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderTasks();
      });
    });

    // ========== –ó–∞–º–µ—Ç–∫–∏ ==========
    const noteInput = document.getElementById('noteInput');
    const charCount = document.getElementById('charCount');
    const saveNoteBtn = document.getElementById('saveNoteBtn');

    let note = localStorage.getItem('note') || '';
    noteInput.value = note;
    charCount.textContent = note.length;

    noteInput.addEventListener('input', () => {
      const value = noteInput.value;
      if (value.length <= 1000) {
        charCount.textContent = value.length;
        note = value;
        localStorage.setItem('note', note);
      } else {
        noteInput.value = note;
      }
    });

    saveNoteBtn.addEventListener('click', () => {
      note = noteInput.value.substring(0, 1000);
      localStorage.setItem('note', note);
      charCount.textContent = note.length;
    });

    // ========== –ü—Ä–∏–±—ã–ª—å ==========
    const targetInput = document.getElementById('targetInput');
    const currentInput = document.getElementById('currentInput');
    const updateProfitBtn = document.getElementById('updateProfitBtn');
    const profitCircle = document.getElementById('profitCircle');
    const profitPercent = document.getElementById('profitPercent');
    const profitDisplay = document.getElementById('profitDisplay');

    let profitData = JSON.parse(localStorage.getItem('profitData')) || { target: '', current: '' };

    function renderProfit() {
      const { target, current } = profitData;
      if (!target || !current) {
        profitDisplay.textContent = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ü–µ–ª—å –∏ —Ç–µ–∫—É—â—É—é –ø—Ä–∏–±—ã–ª—å';
        profitCircle.style.strokeDashoffset = '314';
        profitPercent.textContent = '0%';
        return;
      }

      const percent = Math.min(100, (current / target) * 100);
      const offset = 314 - (314 * percent) / 100;

      profitCircle.style.strokeDashoffset = offset.toString();
      profitPercent.textContent = Math.round(percent) + '%';
      profitDisplay.innerHTML = `–¶–µ–ª—å: ${target} CHF<br>–¢–µ–∫—É—â–∞—è: ${current} CHF`;
    }

    updateProfitBtn.addEventListener('click', () => {
      profitData = {
        target: parseFloat(targetInput.value) || '',
        current: parseFloat(currentInput.value) || ''
      };
      localStorage.setItem('profitData', JSON.stringify(profitData));
      renderProfit();
    });

    targetInput.value = profitData.target;
    currentInput.value = profitData.current;
    renderProfit();

    // ========== XP –°–∏—Å—Ç–µ–º–∞ ==========
    let xpData = JSON.parse(localStorage.getItem('xpData')) || { xp: 0, level: 1 };
    const xpSpan = document.getElementById('xp');
    const levelSpan = document.getElementById('level');
    const nextLevelXpSpan = document.getElementById('nextLevelXp');

    function getNextLevelXp(level) {
      return 100 + (level - 1) * 50;
    }

    function updateXpDisplay() {
      const next = getNextLevelXp(xpData.level);
      xpSpan.textContent = xpData.xp;
      levelSpan.textContent = xpData.level;
      nextLevelXpSpan.textContent = next;

      const xpFill = document.querySelector('.xp-fill');
      if (xpFill) {
        xpFill.style.width = `${Math.min(100, (xpData.xp / next) * 100)}%`;
      }
    }

    function addXP(amount) {
      xpData.xp += amount;
      const next = getNextLevelXp(xpData.level);
      if (xpData.xp >= next) {
        xpData.xp -= next;
        xpData.level++;
        // üéâ –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–¥–µ—Å—å
      }
      localStorage.setItem('xpData', JSON.stringify(xpData));
      updateXpDisplay();
    }

    updateXpDisplay();

    // ========== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ==========
    function saveData() {
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }

    // ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ==========
    updateStats();
    renderTasks();

    // ========== Telegram WebApp ==========
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
      Telegram.WebApp.MainButton.setText("–ì–æ—Ç–æ–≤–æ");
      Telegram.WebApp.MainButton.hide();
    }

    // ========== –°–Ω–µ–≥ (–¥–ª—è –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã) ==========
    function createSnow() {
      const snowflakes = ['‚ùÑ', '‚ùÖ', '‚ùÜ'];
      setInterval(() => {
        const snow = document.createElement('div');
        snow.className = 'snowflake';
        snow.textContent = snowflakes[Math.floor(Math.random() * snowflakes.length)];
        snow.style.left = Math.random() * 100 + 'vw';
        snow.style.opacity = Math.random() * 0.5 + 0.3;
        snow.style.fontSize = (Math.random() * 10 + 10) + 'px';
        snow.style.animationDuration = (Math.random() * 5 + 5) + 's';
        document.body.appendChild(snow);
        setTimeout(() => snow.remove(), 10000);
      }, 300);
    }
    createSnow();
  </script>
</body>
</html>
